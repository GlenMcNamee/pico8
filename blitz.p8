pico-8 cartridge // http://www.pico-8.com
version 15
__lua__
--
-- city blitz
-- 2017 glen mcnamee 
-- glenmcnamee.com
-- @glenmcnamee
--

function _init()
  gamemode = 0;
		levels={}
		levels={"london","madrid"}
end
-->8
--- gameloop

function _intro()
 gamemode = 1
 _initgame()
end

function _initgame()
 lives = 4
 level = 0		 
 _initlevel()
end

function _initlevel()
 xpos = 0
 ypos = 48	
 bomb = 0
 playstatus = 0
 -- create the matrix
 blocks = 0
 mp = {} 
 for i=0,15 do
 
 	tr=2+flr(rnd(6))
  mp[i] = {}
		mp[i][9] = 22
		
 	for j=1,8 do
   mp[i][j] = 0	 
   if i>0 and i<15 then  	
    if tr<j then
     blocks +=1
    	mp[i][j] = 1
    end 
    if tr==j then
     blocks +=1
    	mp[i][j] = 2
    end 
   end
	 end    	
 end         
end
-->8
-- update

function _update()
			if gamemode == 0 then _intro() end	
			if gamemode == 1 then _gameloop() end	
end
-->8
--

function _gameloop()
		_moveplayer()
  _movebomb()
		_checkcontroller()
end

function _moveplayer()
		if playstatus == 0 then
				xpos += 1
		end
  if playstatus == 2 then
  		if ypos > 112 then
				 playstatus = 3
				 ypos = 112 
				else
				 ypos += 1
				 if (xpos>-9) then
					 _colusion(xpos+9,ypos)
					end
				 if (xpos>1) then
					 _colusion(xpos+1,ypos)
					end
				end
		end
				
		if (xpos > 128) then
			xpos -= 128+16  
			ypos += 8
		end
		
		if (ypos>56 and xpos>-15 and xpos<128-16) then
			if _colusion(xpos+15,ypos) then 
				playstatus = 2
			end
		end
end

function _colusion(tx,ty)
				tx=flr(tx/8)
				ty=flr((ty-48)/8)
				if (mp[tx][ty] == 1) then
					mp[tx][ty] = 3

					sfx(0)
					return true
				end
				if (mp[tx][ty] == 2) then
					mp[tx][ty] = 12
					sfx(0)
					return true
				end
				if (mp[tx][ty] > 20) then
					mp[tx][ty] = 23
					bomb=0
					return true
				end
end

function _movebomb()
		-- move bomb
		if (bomb==1) then bomby+=1.3
		if (bomby>56) then
  if	_colusion(bombx,bomby) then
   bomb = 0
  end
			end
		end
end

function _checkcontroller()
		-- check controller
		if (btn(4) or btn(5)) then
			if (bomb == 0) then
			 bomby = ypos + 8
			 bombx = flr(xpos/8)*8
				bomb = 1
			end
		end
end
-->8
---draw 

-- clear the screen, then draw a circle at the current position
function _draw()
  cls()
  if gamemode == 1 then
  		print (levels[1],hcenter(levels[1]),0,8)
    _drawplayer()
		  _drawcity()
		  _drawbomb()
		end
end

function _drawplayer()
  spr (48,xpos,ypos,2,1)
end

function _drawcity()
		print ("blocks "..blocks,0,8)
		--loop for each column
  for x=0,15 do
			y=x
			bx = x-1
			if (bx > 7 ) then bx-=8 end
					for xx=1,9 do					
						if mp[y][xx] == 2 then 
						 --draw roof
						 spr (18+bx,x*8,48+(xx*8))
						end
						if mp[y][xx] == 1 then 
						 --draw floors
						 spr (2+bx,x*8,48+(xx*8))
						end
						if mp[y][xx] == 22 then
							spr (1,x*8,48+(xx*8))
						end
						if mp[y][xx] == 23 then
							spr (17,x*8,48+(xx*8))
						end
						
  				-- explosions
						if mp[y][xx] >2 and mp[y][xx] <21 then 
							if mp[y][xx] <12 then
							 exo = mp[y][xx]-2
							 fl = 0
							else
							 exo = mp[y][xx]-11
							 fl = 1
							end
							if exo < 4 then
								if fl == 0 then
							  spr (2+bx,x*8,48+(xx*8))									
								else
								 spr (18+bx,x*8,48+(xx*8))
								end
						 end
						 spr (50+exo,x*8,48+(xx*8))
						 if exo < 9 then
						  mp[y][xx] += 1
						 else
						 	mp[y][xx] = 0
						 	blocks -= 1
						 	if blocks == 0  then
						 		playstatus = 1
						 	end
						 end
						end		
					end
			end						
end

function _drawbomb()
 if (bomb==1) then
		spr (50,bombx,bomby)			
	end
end	

function hcenter(s)
	return 64-flr((#s*4)/2)
end
__gfx__
00000000333333337007007077777770707070707777777070707070700700707777777070707070000000000000000000000000004994000000000000000000
00000000bb3bbb3b7777777070070070707070707707077077777770777777707007007070707070000000000000000000000000049aa9400000000000000000
00000000b4b5b4b4700700707007007070707070770707707070707070070070700700707070707000000000000050000005000049aaaa940000500000000000
0000000044b444b577777770777777707777777077777770777777707777777077777770777777700600000000006000005650009aaaaaa90005a50000000000
000000005444544970070070777777707070707077777770707070707007007077777770707070700000000000567650000500009aaaaaaa0000500000000000
0000000054944454777777707007007070707070770707707777777077777770700700707070707000000000000060000000000049aaaa940000000000000000
00000000545444957007007070070070707070707707077070707070700700707007007070707070000000000000500000000000049aa9400000000000000000
00000000944545457777777077777770777777707777777077777770777777707777777077777770000000000000000000000000004994000000000000000000
00499400300000030005000000060000000500000005000000050000005500750005000000050000000000000000000288888200888882008888820088888200
049aa940b230023b0057500000070000000600000057500000060000007777750006000000575000000000000270000008008002080080000800800008008000
49aaaa94b42522240507050000070000000700000507050000565000007777700007000005070500000000002877008080080008800800028008000080080000
9aaaaaa944b224b5060706000007000000070000067776000060600000777750000700000677760000000000887708882882880e288288082882880228828800
9aaaaaa954425449577777500067600000575000500700500577750000707500005750005007005000000000887788222222288e2222288e2222288822222882
49aaaa9454944454670707600077700000676000677777600607060000700000006760006777776000000000288888888888880e888888088888880288888800
049aa940545444957707077006777600057775007007007057070750057775000577750070070070000000000888888888888008888880028888800088888000
00499400944545457777777067777760567776507777777067777760577777505777775077777770000000000200000002000002020000000200000002000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00050000200000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00565000400000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00050000540000490000005000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000
00000000540004540005777000000000000000500505000050000000000000000000005000605000000000000000000000000000000000000000000000000000
00000000545444955007007000050000505000705606050070000050000500500005006050706050000000000000000000000000000000000000000000000000
00000000944545457777777057777500757777707777760077750570505777700076777067777760000000000000000000000000000000000000000000000000
000000028888820000ccc0000000000000000000000000000002200000222200002222000000200000002000000000000000000000c0000000ccc00000000000
0270000008008002000c0000000000000000000000088000002992000299992002999920002092002000020000000000c0cccc000c0c0000000c000000000000
287700808008000800ccc000000000000008800000899800029aa920299aa99229a00a92029009200000002000000000ccccccc000ccc00000ccc00000000000
887708882882880e00ccc000000494000089a900089aa9802a777a902a777a922a000a922a0000900000009000000000c0cccc0000cccc0000ccc00000000000
887788222222288e00cc70000009a900089a7a8009a77a902a777a902a777a922a0000922a000a90000000000000000000000000000ccc0000ccc00000000000
288888888888880e00cc70000004940000899800089aa98009aaaa9029aaaa9229a00a9209a000902000000000000000000000000000cc0000ccc00000000000
0888888888888008000700000000000000088000008998000299992002999920029aa9200290092002000020000000000000000000000000000c000000000000
02000000020000020000000000000000000000000008800000222200002222000022220000202200000022000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000567650000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000056777765000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055555555000000577777777500000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000677777777750000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000056777777777776500000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055555555000567777777777777750000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055555555000677777777777777775000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000677777777777777777000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055555555000577777777777777776000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055555555000056677777777777765000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055555555000000005677655677650000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111000000000566500576500000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055555555000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055555555000000056765000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111000000567776500000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111000005777777650000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055555555000567777777776665000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111005777777777777777600000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111056777777777777777760000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111577777777777777777776000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000cccccccc777777777777777777777650
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111577777777777777777777776
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111056677777777777777776655
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000cccccccc000055666677776655000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000cccccccc000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000cccccccc000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000cccccccc000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000cccccccc000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000b000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000200000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000400000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000400000007000000090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000400000007000000090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000200000400000007000000090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000001010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
00010000166501d650246502a6502f650316503465036650396503a6503b6503b6503a650396503765033650306502d6502865024650216501f6501d6501965014650116500f6500d6500b6500a6500a6500a650
